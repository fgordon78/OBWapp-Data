#combine data into one big table

library(sqldf)

#work only with distinct entries
likes2 = likes[,c(2:5)]

#some beer are entered twice by a single user; as a like and a favorite.  
#Change this around so a user can only like or favorite a given beer

likes3 = likes2[which(likes2$like_type == "2"), c(1,2)]
likes3$favorite = "Y"

likes4 = likes2[which(likes2$like_type == "1"), c(1,2)]
likes4$like= "Y"

likes5 = likes2[,c(1:3)]
likes5 = sqldf("select distinct * from likes5")

likes5 = sqldf("select L5.*,
               L4.like,
               L3.favorite
               from likes5 as L5 left join likes4 as L4 on
               L5.device_guid = L4.device_guid and L5.beer_id = L4.beer_id
               left join likes3 as L3 on
               L5.device_guid = L3.device_guid and L5.beer_id = L3.beer_id")

likes5$preference = ifelse(is.na(likes5$favorite),"like","favorite")

t = sqldf("select distinct L5.device_guid, L5.age, L5.beer_id, L5.preference,
          FD.lat, FD.lon,
          RS.establishment_id, RS.last_report_update
          from likes5 as L5 inner join futuredata as FD on
          L5.device_guid = FD.device_guid and L5.beer_id = FD.beer_id
          left join reportstate as RS on
          L5.device_guid = RS.device_guid and L5.beer_id = RS.beer_id")



#neither lon/lat or establishment_id are fully reliable due to data completeness so get name if available

t2 = sqldf("select distinct t.*,
              e.name,
              e2.name as name2
              from t left join establishments as e on 
              t.lat = e.lat and t.lon = e.lon
              left join establishments as e2
              on t.establishment_id = e2.id")

t2$bar_name = ifelse(is.na(t2$name),t2$name2,t2$name)
t2$place = ifelse(is.na(t2$bar_name),"other",t2$bar_name)

t2 = t2[,c(1:8,12)]

#fill in more information about the bar (if available) and the beer

t3 = sqldf ("select distinct t2.*,
           e.address,
           b.name as beer_name, b.brewery, b.description, b.ibu, b.abv, b.limited_release, b.rate_beer_id
          from t2 left join establishments as e on 
          t2.place = e.name
          left join beers as b
          on t2.beer_id = b.id")

#clean data by changing /N to 0 where there is no ibu or abv information

t3$ibu = ifelse(t3$ibu <= 10,0,t3$ibu)
t3$abv = ifelse(t3$abv <= 0,0,t3$abv)
